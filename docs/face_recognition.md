# Python 人脸识别

## 人脸识别十大关键技术

### 1. **人脸检测(Face Detection)**

“人脸检测”的作用就是要检测出图像中人脸所在位置。人脸检测算法的原理简单来说是一个“扫描”加“判定”的过程。即首先在整个图像范围内扫描，再逐个判定候选区域是否是人脸的过程。因此人脸检测算法的计算速度会跟图像尺寸大小以及图像内容相关。在实际算法时，我们可以通过设置“输入图像尺寸”、或“最小脸尺寸限制”、“人脸数量上限”的方式来加速算法。

### 2. **人脸配准(Face Alignment)**

“人脸配准”所实现的目的是定位出人脸上五官关键点坐标。当前效果的较好的一些人脸配准技术基本通过深度学习框架实现。这些方法都是基于人脸检测的坐标框，按某种事先设定规则将人脸区域抠取出来，缩放到固定尺寸，然后进行关键点位置的计算。另外，相对于人脸检测，或者是后面将提到的人脸特征提取的过程，人脸配准算法的计算耗时都要少很多。

### 3. **人脸提特征(Face Feature Extraction)**

“人脸提特征”是将一张人脸图像转化为可以表征人脸特点的特征，具体表现形式为一串固定长度的数值。

人脸提特征过程的输入是“一张人脸图”和“人脸五官关键点坐标”，输出是人脸相应的一个数值串(特征)。人脸提特征算法实现的过程为：首先将五官关键点坐标进行旋转、缩放等等操作来实现人脸对齐，然后在提取特征并计算出数值串。

### 4. **人脸识别(Face Recognition)**

“人脸识别”是识别出输入人脸图对应身份的算法。

它的输入为一个人脸特征，通过和注册在库中N个身份对应的特征进行逐个比对，找出“一个”与输入特征相似度最高的特征。将这个最高相似度值和预设的阈值相比较，如果大于阈值，则返回该特征对应的身份，否则返回“不在库中”。

### 5. **人脸属性识别(facial attribute recognition)**

“人脸属性识别”是识别出人脸的性别、年龄、姿态、表情等属性值的一项技术。这在有些相机APP中有所应用，可以自动识别摄像头视野中人物的性别、年龄等特征并标注出来。

人脸的属性识别包括性别识别、年龄估计、表情识别、姿态识别、发型识别等等方面。一般来说每种属性的识别算法过程是独立的，但是有一些新型的基于深度学习实现的算法可以实现同时输出年龄、性别、姿态、表情等属性识别结果。

### 6. **人脸比对(Face Compare)**

“人脸比对”算法实现的目的是衡量两个人脸之间相似度。

人脸比对算法的输入是两个人脸特征人脸特征由前面的人脸提特征算法获得，输出是两个特征之间的相似度。

### 7. **人脸验证(Face Verification)**

“人脸验证”是判定两个人脸图是否为同一人的算法。

它的输入是两个人脸特征，通过人脸比对获得两个人脸特征的相似度，通过与预设的阈值比较来验证这两个人脸特征是否属于同一人。

### 8. **人脸检索(Face Retrieval)**

“人脸检索”是查找和输入人脸相似的人脸序列的算法。

人脸检索通过将输入的人脸和一个集合中的说有人脸进行比对，根据比对后的相似度对集合中的人脸进行排序。根据相似度从高到低排序的人脸序列即使人脸检索的结果。

### 9. **人脸聚类(Face Cluster)**

“人脸聚类”是将一个集合内的人脸根据身份进行分组的算法。

在没有进行人工身份标注前，只知道分到一个组的人脸是属于同一个身份，但不知道确切身份。

### 10. **人脸活体(Face Liveness)**

“人脸活体”是判断人脸图像是来自真人还是来自攻击假体(照片、视频等)的方法。

在我们生活环境中，人脸认证系统中主要容易受到这种手段欺骗：

1. 用偷拍的照片假冒真实人；
2. 在公开场合录的视频或网上公开的视频片段；
3. 用计算机辅助软件设计的三维模型欺骗；
4. 用蜡或塑料等材质构造的三维雕像欺骗。

现在所以人脸活体检测技术的研究显得异常重要。对于照片欺骗，主要是根据分辨率、三位三维信息、眼动等来进行区分；对于视频欺骗，根据三维信息、光线等来区分。

## 人脸识别算法原理

### 1、基于几何特征的方法

人脸由眼睛、鼻子、嘴巴、下巴等部件构成，正因为这些部件的形状、大小和结构上的各种差异才使得世界上每个人脸千差万别，因此对这些部件的形状和结构关系的几何描述，可以做为人脸识别的重要特征。几何特征最早是用于人脸侧面轮廓的描述与识别，首先根据侧面轮廓曲线确定若干显著点，并由这些显著点导出一组用于识别的特征度量如距离、角度等。

### 2、局部特征分析方法

局部特征分析方法一种基于特征表示的面像识别技术，源于类似搭建积木的局部统计的原理。LFA 基于所有的面像(包括各种复杂的式样)都可以从由很多不能再简化的结构单元子集综合而成。

这些单元使用复杂的统计技术而形成，它们代表了整个面像，通常跨越多个像素(在局部区域内)并代表了普遍的面部形状，但并不是通常意义上的面部特征。实际上，面部结构单元比面像的部位要多得多。 然而，要综合形成一张精确逼真的面像， 只需要整个可用集合中很少的单元子集(12～ 40 特征单元)。

要确定身份不仅仅取决于特性单元，还决定于它们的几何结构(比如它们的相关位置)。通过这种方式，LFA 将个人的特性对应成一种复杂的数字表达方式，可以进行对比和识别。

“面纹”编码方式是根据脸部的本质特征和形状来工作的，它可以抵抗光 线、皮肤色调、面部毛发、发型、眼镜、表情和姿态的变化，具有强大的可靠性，以从百万人中精确地辨认出一个人。

### 3、特征脸方法(Eigenface或PCA)

从统计的观点，寻找人脸图像分布的基本元素，即人脸图像样本集协方差矩阵的特征向量，以此近似地表征人脸图像。这些特征向量称为特征脸(Eigenface)。

该方法是先确定眼虹膜、鼻翼、嘴角等面像五官轮廓的大小、位置、距离等属性，然后再计算出它们的几何特征量，而这些特征量形成一描述该面像的特征向量。其技术的核心实际为“局部人体特征分析”和“图形/神经识别算法。

### 4、基于弹性模型的方法

弹性图匹配技术是一种基于几何特征和对灰度分布信息进行小波纹理分析相结合的识别算法，较好的利用了人脸的结构和灰度分布信息，而且还具有自动精确定位面部特征点的功能，因而具有良好的识别效果，适应性强识别率较高，该技术在FERET测试中若干指标名列前茅，其缺点是时间复杂度高，速度较慢，实现复杂。

### 5、神经网络方法(Neural Networks)

神经网络方法在人脸识别上的应用比起前述几类方法来有一定的优势，因为对人脸识别的许多规律或规则进行显性的描述是相当困难的，而神经网络方法则可以通过学习的过程获得对这些规律和规则的隐性表达，它的适应性更强，一般也比较容易实现。

因此人工神经网络识别速度快，但识别率低 。而神经网络方法通常需要将人脸作为一个一维向量输入，因此输入节点庞大，其识别重要的一个目标就是降维处理。

### 6、其他方法

除了以上几种方法，人脸识别还有其它若干思路和方法，包括一下一些：

(1)隐马尔可夫模型方法(Hidden Markov Model)

(2)Gabor 小波变换+图形匹配

(3)人脸等密度线分析匹配方法

## 人脸识别技术难点

### 1、光照问题

光照问题是机器视觉重的老问题，在人脸识别中的表现尤为明显。由于人脸的3D结构，光照投射出的阴影，会加强或减弱原有的人脸特征。尤其是在夜晚，由于光线不足造成的面部阴影会导致识别率的急剧下降，使得系统难以满足实用要求。

### 2、表情姿态问题

与光照问题类似，表请和姿态问题也是目前人脸识别研究中需要解决的一个技术难点。面部幅度较大的哭、笑、愤怒等表情变化同样影像着面部识别的准确率。姿态问题涉及头部在三维垂直坐标系中绕三个轴的旋转造成的面部变化，其中垂直于图像平面的两个方向的深度旋转会造成面部信息的部分缺失，使得表情姿态问题成为人脸识别的一个技术难题。

### 3、遮挡问题

对于非配合情况下的人脸图像采集，遮挡问题是一个非常严重的问题。特别是在监控环境下，往往彼监控对象都会带着眼镜，帽子等饰物，使得被采集出来的人脸图像有可能不完整，从而影响了后面的特征提取与识别，甚至会导致人脸检测算法的失效。

### 4、年龄变化

随着年龄的变化，面部外观也在变化，特别是对于青少年，这种变化更加的明显。对于不同的年龄段，人脸识别算法的识别率也不同。一个人从少年变成青年，变成老年，他的容貌可能会发生比较大的变化，从而导致识别率的下降。对于不同的年龄段，人脸识别算法的识别率也不同。

### 5、人脸相似性

不同个体之间的区别不大，所有的人脸的结构都相似，甚至人脸器官的结构外形都很相似。这样的特点对于利用人脸进行定位是有利的，但是对于利用人脸区分人类个体是不利的。

### 6、图像质量

人脸图像的来源可能多种多样，由于采集设备的不同，得到的人脸图像质量也不一样，特别是对于那些低分辨率、噪声大、质量差的人脸图像(如手机摄像头拍摄的人脸图片、远程监控拍摄的图片等)如何进行有效地人脸识别是个需要关注的问题。同样的，对于高分辨图像对人脸识别算法的影响也需要进一步的研究。

## 人脸识别流程

一般而言，一个完整的人脸识别系统包含三大主要组成部分，即人脸检测、人脸配准以及人脸识别。

三者流水线操作：

1. 人脸检测在图像中找到人脸的位置，并且提取人脸的特征，这个过程称之为人脸检测。
2. 接着人脸配准在人脸上找到眼睛、鼻子、嘴巴等面部器官的位置。
3. 最后人脸识别抽取特征与既有人脸比对计算相似度，确认人脸对应的身份。

![Face-Tracking-Android-Application-Structure](/assets/images/face_recognition/face_recognition_flow.png)

### 第一步：找出所有的面孔（人脸检测）

很显然在我们在人脸识别的流程中得首先找到图片中的人脸。我们在使用手机或相机拍照时都会有人像模式，它能轻松的检测出人脸的位置，帮助相机快速对焦。

![自动对焦](/assets/images/face_recognition/auto_focus.jpg)

相机对焦我们得感谢 **保罗·比奥拉（Paul Viola）** 和 **迈克尔·琼斯（Michael Jones）** 在2000年 发明了一种能够快速在廉价相机上运行的人脸检测方法，人脸检测在相机上的应用才成为主流。然而现在我们有更可靠的解决方案**HOG（Histogram of Oriented Gradients）方向梯度直方图** ，一种能够检测物体轮廓的算法。

首先我们把图片灰度化，因为颜色信息对于人脸检测而言没什么用。

![奧黛麗·赫本 (Audrey Hepburn)](/assets/images/face_recognition/audrey_hepburn.jpg)

我们分析每个像素以及其周围的像素，根据明暗度画一个箭头，箭头的指向代表了像素逐渐变暗的方向，如果我们重复操作每一个像素，最终像素会被箭头取代。这些箭头被称为**梯度(gradients)**，它们能显示出图像从明亮到黑暗流动的过程。

![HOG Director](/assets/images/face_recognition/hog_director.jpg)

分析每个像素对我们来说有点不划算，因为它太过细节化了，我们可能会迷失在像素的海洋里，我们应该从更高的角度观察明暗的流动。

为此我们将图像分割成16x16像素的小方块。在每个小方块中，计算出每个主方向有多少个剃度（有多少指向上，指向右上，指向右等）。然后用指向性最强的那个方向箭头来代替原来那个小方块。

![face_fhog_filters](/assets/images/face_recognition/face_fhog_filters.png)

最终结果，我们把原始图像转换成一个非常简单的HOG表达形式，它可以很轻松的捕获面部的基本结构。

为了在HOG图像中找到脸部，我们需要做的是，与已知的一些HOG图案中，看起来最相似的部分。这些HOG图案都是重其他面部训练数据中提取出来的。

### 第二步：脸部的不同姿势（人脸配准）

我们已经找出了图片中的人脸，那么如何鉴别面朝不同方向的人脸呢？

对于电脑来说朝向不同的人脸是不同的东西，为此我们得适当的调整扭曲图片中的人脸，使得眼睛和嘴总是与被检测者重叠。

为了达到目的我们将使用一种 **面部特征点估计（face landmark estimation）** 的算法。其实还有很多算法都可以做到，但我们这次使用的是由 **瓦希德·卡奇米（Vahid Kazemi）** 和 **约瑟菲娜·沙利文（Josephine Sullivan）** 在 2014 年发明的方法。

这一算法的基本思路是找到68个人脸上普遍存在的点（称为**特征点，landmark**）

![landmark_68_point](/assets/images/face_recognition/landmark_68_point.jpg)

* 下巴轮廓17个点 [0-16]
* 左眉毛5个点 [17-21]
* 右眉毛5个点 [22-26]
* 鼻梁4个点 [27-30]
* 鼻尖5个点 [31-35]
* 左眼6个点 [36-41]
* 右眼6个点 [42-47]
* 外嘴唇12个点 [48-59]
* 内嘴唇8个点 [60-67]

有了这68个点，我们就可以轻松的知道眼睛和嘴巴在哪儿了，后续我们将图片进行旋转，缩放和错切，使得眼睛和嘴巴尽可能的靠近中心。

现在人脸基本上对齐了，这使得下一步更加准确。

### 第三步：TA是谁（人脸识别）

#### 给脸部编码

我们还有个核心的问题没有解决， 那就是如何区分不同的人脸。

最简单的方法就是把我们第二步中发现的未知人脸与我们已知的人脸作对比。当我们发现未知的面孔与一个以前标注过的面孔看起来相似的时候，就可以认定他们是同一个人。

我们人类能通过眼睛大小，头发颜色等等信息轻松的分辨不同的两张人脸，可是电脑怎么分辨呢？没错，我们得量化它们，测量出他们的不同，那要怎么做呢？

#### 测量人脸的最可靠的方法

如何测量人脸的数值呢？耳朵大小？鼻子长度？眼睛的颜色？

实际上，对于人脸这些信息很容易分辨，可是对于计算机，这些值没什么价值。实际上最准确的方法是让计算机自己找出他要收集的测量值。深度学习比人类更懂得哪些面部测量值比较重要。

所以，解决方案是训练一个深度卷积神经网络，训练让它为脸部生成128个测量值。

每次训练要观察三个不同的脸部图像：

加载一张已知的人的面部训练图像

加载同一个人的另一张照片

加载另外一个人的照片

然后，算法查看它自己为这三个图片生成的测量值。再然后，稍微调整神经网络，以确保第一张和第二张生成的测量值接近，而第二张和第三张生成的测量值略有不同。

我们要不断的调整样本，重复以上步骤百万次，这确实是个巨大的挑战，但是一旦训练完成，它能够轻松的找出人脸。

庆幸的是 OpenFace 上面的大神已经做完了这些，并且他们发布了几个训练过可以直接使用的网络，我们可以不用部署复杂的机器学习，开箱即用，感谢开源精神。

![d_value_128](/assets/images/face_recognition/d_value_128.png)

这128个测量值是什么鬼？

其实我们不用关心，这对我们也不重要。我们关心的是，当看到同一个人的两张不同照片时，我们的网络需要能得到几乎相同的数值。

#### 从编码中找出人的名字

最后一步实际上是最简单的一步，我们需要做的是找到数据库中与我们的测试图像的测量值最接近的那个人。

如何做呢，我们利用一些现成的数学公式，计算两个128D数值的欧氏距离

![euclidean_distance](/assets/images/face_recognition/euclidean_distance.png)

哈，这样我们得到一个欧式距离值，系统将给它一个认为是同一个人欧氏距离的阀值，即超过这个阀值我们就认定他们是同一个人。

人脸识别就这样达成啦，来来我们再回顾下流程：

使用HOG找出图片中所有人脸的位置。
计算出人脸的68个特征点并适当的调整人脸位置，对齐人脸。
把上一步得到的面部图像放入神经网络，得到128个特征测量值，并保存它们。
与我们以前保存过的测量值一并计算欧氏距离，得到欧氏距离值，比较数值大小，即可得到是否同一个人。

## 人脸识别

![Face-Tracking-Android-Application-Structure](/assets/images/face_recognition/Face-Tracking-Android-Application-Structure.jpg)

## 安装Python依赖包

### TensorFlow

```shell
pip install tensorflow
```

### OpenCV

安装的时候会附带把NumPy也装了。

```shell
pip install opencv-python
pip install opencv-python-headless
```

### Dlib

```shell
# 首先安装CMake
pip install cmake
# 接着就可以编译安装Dlib了。
pip install dlib
```

### NumPy

```shell
pip install numpy
```

## 参考资料

* [How to install dlib library for Python in Windows 10](https://medium.com/analytics-vidhya/how-to-install-dlib-library-for-python-in-windows-10-57348ba1117f)
* [How to Install NumPy](https://phoenixnap.com/kb/install-numpy)
* [Python Tensorflow安装，使用教程](https://zhuanlan.zhihu.com/p/56210706)
* [TensorFlow人脸识别（TensorFlow+Dlib+OpenCV）基于深度学习的人脸识别](https://blog.csdn.net/happywlg123/article/details/86719292)
* [轻量级人脸检测模型](https://github.com/Linzaer/Ultra-Light-Fast-Generic-Face-Detector-1MB/blob/master/README_CN.md)
* [OpenCV和Dlib人脸识别基础](https://www.cnblogs.com/geoffreygao/p/12233838.html)
* [人脸识别原理与模型方法综述](https://zhuanlan.zhihu.com/p/258101535)
* [深入浅出人脸识别原理](https://dxyoo7.github.io/2017/11/28/face_recognition/)
* [Viola–Jones object detection framework](https://en.wikipedia.org/wiki/Viola%E2%80%93Jones_object_detection_framework)
* [Histogram of oriented gradients](https://en.wikipedia.org/wiki/Histogram_of_oriented_gradients)
* [人脸识别·美妆·动效自拍背后的技术——人脸配准](https://toutiao.io/posts/nbllxh/preview)
* [一文梳理人脸识别，看完全都懂了！](https://www.toutiao.com/article/6675200385763770888/?wid=1650076410070)
* [人脸关键点检测](https://niuyuanyuanna.github.io/2018/11/08/computer_version/face-keypoint-detection)
